<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Customer Experience DX Team] YouTube Video Analysis Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        .hero {
            width: 100%;
            min-height: 100vh;
            background-color: #592321;
            background-image: url('https://raw.githubusercontent.com/taesung01/youtube-analysis-form/main/image.png');
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-position: center center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px 40px;
            border-radius: 12px;
            text-align: center;
            width: 85%;
            max-width: 750px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(75.6px);
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }
        .analysis-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            fill: #FF0000;
        }
        .app-logo {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }
        .main-title {
            font-size: 24px;
            font-weight: bold;
            color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .label-input {
            font-size: 17px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            text-align: left;
        }
        .input-example {
            font-size: 13px;
            color: #666;
            text-align: left;
            margin-bottom: 10px;
            font-style: italic;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 14px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            margin-bottom: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, input[type="email"]:focus {
            border-color: #FF0000;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
            outline: none;
        }
        input::placeholder {
            color: #999;
        }
        select {
            width: 100%;
            padding: 14px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            margin-bottom: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        select:focus {
            border-color: #FF0000;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
            outline: none;
        }
        button {
            width: 100%;
            padding: 16px;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #e60000;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .reset-button {
            background-color: #666;
        }
        .reset-button:hover {
            background-color: #555;
        }
        .button-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        .success-message {
            background-color: #e6ffe6;
            color: #007700;
            border: 1px solid #00cc00;
        }
        .error-message {
            background-color: #ffe6e6;
            color: #cc0000;
            border: 1px solid #ff0000;
        }
        .privacy-link {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
        }
        .privacy-link a {
            color: #FF0000;
            text-decoration: none;
        }
        .privacy-link a:hover {
            text-decoration: underline;
        }
        .app-purpose {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
            text-align: left;
            line-height: 1.6;
        }
        .app-purpose h3 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="hero">
        <div class="container">
            <div class="logo-container">
                <!-- 새로운 로고 이미지 반영 -->
                <img src="https://raw.githubusercontent.com/taesung01/youtube-analysis-form/main/logo.png" alt="LG CXDX YouTube Analysis Agent Logo" class="app-logo">
                <svg class="analysis-icon" viewBox="0 0 24 24">
                    <path d="M4,4h16c1.1,0,2,0.9,2,2v12c0,1.1-0.9,2-2,2H4c-1.1,0-2-0.9-2-2V6C2,4.9,2.9,4,4,4z" fill="#FF0000" opacity="0.8"/>
                    <path d="M10,9l5,3l-5,3V9z" fill="white"/>
                    <path d="M5,15.5L7,14l2,1l3-3l2,2" stroke="white" stroke-width="1.5" fill="none"/>
                    <circle cx="5" cy="15.5" r="1" fill="white"/>
                    <circle cx="7" cy="14" r="1" fill="white"/>
                    <circle cx="9" cy="15" r="1" fill="white"/>
                    <circle cx="12" cy="12" r="1" fill="white"/>
                    <circle cx="14" cy="14" r="1" fill="white"/>
                </svg>
                <div class="main-title">
                    [Customer Experience DX Team] YouTube Video Analysis Agent
                </div>
            </div>
            <form id="analysis-form">
                <div class="label-input">Enter YouTube Video URL</div>
                <input type="text" id="videoUrl" name="videoUrl" required placeholder="Enter YouTube video URL">
                <div class="input-example">Example: https://www.youtube.com/watch?v=ZJzxje3rmnI</div>
                
                <div class="label-input">Select Email Address</div>
                <select id="emailSelect" name="emailSelect" required>
                    <option value="" disabled selected>Select a team member's email</option>
                    <option value="direct">Enter manually</option>
                    <option value="changil.shin@lge.com">Changil Shin (changil.shin@lge.com)</option>
                    <option value="jihye80.kim@lge.com">Jihye Kim (jihye80.kim@lge.com)</option>
                    <option value="philsoo.kim@lge.com">Philsoo Kim (philsoo.kim@lge.com)</option>
                    <option value="wade.kim@lge.com">Hoyeon Kim (wade.kim@lge.com)</option>
                    <option value="taesung01.lee@lge.com">Taesung Lee (taesung01.lee@lge.com)</option>
                    <option value="sean.chong@lge.com">Kapsung Chung (sean.chong@lge.com)</option>
                    <option value="hoyoung.chung@lge.com">Hoyoung Chung (hoyoung.chung@lge.com)</option>
                    <option value="sunghoon.cha@lge.com">Sunghoon Cha (sunghoon.cha@lge.com)</option>
                    <option value="boram86.choi@lge.com">Boram Choi (boram86.choi@lge.com)</option>
                    <option value="dahee3.kim@lge.com">Dahee Kim (dahee3.kim@lge.com)</option>
                </select>
                <input type="email" id="emailDirect" name="email" placeholder="Enter email address" style="display: none;">
                <div class="input-example">Select a team member's email or enter manually</div>
                
                <div style="text-align: left; margin: 15px 0;">
                    <label>
                        <input type="checkbox" id="analyzeComments" name="analyzeComments">
                        Check this box if you want a detailed analysis of all comments on the requested video
                    </label>
                </div>
                
                <input type="hidden" id="videoId" name="videoId">
                
                <button type="submit" id="submit-button">
                    <div class="loading-spinner" id="loading-spinner"></div>
                    <svg class="button-icon" viewBox="0 0 24 24" fill="white" id="button-icon">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zM12 9c-.55 0-1 .45-1 1v1h2v-1c0-.55-.45-1-1-1z"></path>
                    </svg>
                    Analyze
                </button>
            </form>
            <!-- 인증 리셋 버튼 추가 (이전 요청 반영) -->
            <button id="reset-button" class="reset-button">
                Reset Authentication
            </button>
            <div id="result" class="result-message"></div>
            <!-- 앱 목적 설명 섹션 추가 -->
            <div class="app-purpose">
                <h3>About LG CXDX YouTube Analysis Agent</h3>
                <p>The LG CXDX YouTube Analysis Agent is a tool developed by the LG Electronics Customer Experience DX Team to analyze YouTube videos and their associated comments. This tool helps our team understand customer feedback, perform sentiment analysis, and identify areas for product and service improvement. Authorized team members can input a YouTube video URL and an email address to initiate an automated analysis. The results are used internally to enhance LG's customer experience initiatives. For more details on how we handle your data, please refer to our <a href="https://taesung01.github.io/youtube-analysis-form/privacy-policy.html">Privacy Policy</a>.</p>
            </div>
            <div class="privacy-link">
                <a href="https://taesung01.github.io/youtube-analysis-form/privacy-policy.html" target="_blank">Privacy Policy</a>
            </div>
        </div>
    </div>

    <script>
        // OAuth2 설정 (이전 요청 반영)
        const CLIENT_ID = '26174482972-b462avpkrvp0atfuqaqsgb2m713jrhos.apps.googleusercontent.com';
        const REDIRECT_URI = 'https://taesung01.github.io/youtube-analysis-form/auth-callback.html';
        const SCOPE = 'https://www.googleapis.com/auth/youtube.force-ssl';
        const AUTH_URL = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${SCOPE}&state=auth`;

        function extractVideoId(url) {
            if (!url) return null;
            const regex = /(?:https?:\/\/(?:www\.)?youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|(?:.*[?&]v=))([^"&?/\s]{11}))/;
            let match = url.match(regex);
            if (!match) {
                const altRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|shorts\/|watch\?v=|watch\?.+&v=))([^?&\/]{11})/;
                match = url.match(altRegex);
            }
            return match ? match[1] : null;
        }

        function displayResult(message, type) {
            const resultDiv = document.getElementById("result");
            resultDiv.style.display = "block";
            resultDiv.className = "result-message " + (type === "success" ? "success-message" : "error-message");
            // 앱 이름을 메시지에 추가 (이전 요청 반영)
            resultDiv.innerHTML = '<h2>LG CXDX YouTube Analysis Agent</h2>' + message;
            if (type === "success") {
                document.getElementById("videoUrl").value = "";
                if (document.getElementById("videoId")) {
                    document.getElementById("videoId").value = "";
                }
            }
        }

        // 팝업 창에서 보낸 메시지 수신 (이전 요청 반영)
        window.addEventListener('message', function(event) {
            if (event.data === 'authSuccess') {
                // 액세스 토큰 저장
                const hash = window.location.hash;
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                if (accessToken) {
                    localStorage.setItem('accessToken', accessToken);
                }
                displayResult("✅ OAuth2 authentication completed successfully!", "success");
            } else if (event.data === 'authFailed') {
                displayResult("❌ OAuth2 authentication failed. Please try again.", "error");
            }
            document.getElementById("submit-button").disabled = false;
            document.getElementById("loading-spinner").style.display = "none";
            isSubmitting = false;
        });

        const webhookUrl = "https://hook.eu2.make.com/9cr0lgsbj4gcrvnc81nr6hu82927rawn";
        const emailScriptUrl = "https://script.google.com/macros/s/AKfycbzDMEzLw7p0plFKzuYVJeRa4bYdux2ZSjPhb1tY16XdRg_f5eVzwvLiYlsDTCvCzLaaPA/exec";
        let isSubmitting = false;

        document.getElementById("emailSelect").addEventListener("change", function() {
            const emailDirectInput = document.getElementById("emailDirect");
            if (this.value === "direct") {
                emailDirectInput.style.display = "block";
                emailDirectInput.required = true;
            } else {
                emailDirectInput.style.display = "none";
                emailDirectInput.required = false;
                emailDirectInput.value = "";
            }
        });

        // 인증 리셋 기능 (이전 요청 반영)
        document.getElementById("reset-button").addEventListener("click", async function() {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                displayResult("No authentication token found to reset.", "error");
                return;
            }

            try {
                // Google OAuth 권한 철회 API 호출
                const response = await fetch(`https://accounts.google.com/o/oauth2/revoke?token=${accessToken}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    // 로컬 저장소에서 토큰 삭제
                    localStorage.removeItem('accessToken');
                    displayResult("✅ Authentication has been reset successfully. Please authenticate again.", "success");
                } else {
                    displayResult("❌ Failed to reset authentication. Please try again.", "error");
                }
            } catch (error) {
                displayResult("❌ An error occurred while resetting authentication: " + error.message, "error");
            }
        });

        document.getElementById("analysis-form").addEventListener("submit", async function(event) {
            event.preventDefault();
            
            if (isSubmitting) return;
            isSubmitting = true;

            const videoUrl = document.getElementById("videoUrl").value;
            const videoId = extractVideoId(videoUrl);
            const emailSelect = document.getElementById("emailSelect").value;
            const emailDirect = document.getElementById("emailDirect").value;
            const analyzeComments = document.getElementById("analyzeComments").checked;
            let email = emailSelect === "direct" ? emailDirect : emailSelect;

            if (!videoId || !email) {
                displayResult("Please enter a valid YouTube URL and email address.", "error");
                isSubmitting = false;
                return;
            }

            document.getElementById("videoId").value = videoId;
            document.getElementById("submit-button").disabled = true;
            document.getElementById("loading-spinner").style.display = "inline-block";
            document.getElementById("result").style.display = "none";

            // 인증 시작 전에 앱 이름 표시 (이전 요청 반영)
            displayResult("Initiating OAuth2 authentication with LG CXDX YouTube Analysis Agent...", "success");

            // 팝업 창 열기
            const popup = window.open(AUTH_URL, 'OAuth2 Authentication', 'width=600,height=600');
            if (!popup) {
                displayResult("The popup window was blocked. Please allow popups in your browser settings.", "error");
                document.getElementById("submit-button").disabled = false;
                document.getElementById("loading-spinner").style.display = "none";
                isSubmitting = false;
                return;
            }

            const requestData = { 
                video_url: videoUrl,
                videoId: videoId,
                email: email
            };

            try {
                // 기본 분석 요청 (Make.com)
                await fetch(webhookUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData),
                    signal: AbortSignal.timeout(10000)
                });

                // 댓글 분석 요청 (Google Apps Script로 자동 이메일 전송)
                if (analyzeComments) {
                    const commentsRequestData = {
                        video_url: videoUrl,
                        email: email,
                        sendTo: "lg.cxinnovationdx.team@gmail.com"
                    };

                    const params = new URLSearchParams(commentsRequestData).toString();

                    await fetch(emailScriptUrl + '?' + params, {
                        method: "POST",
                        mode: 'no-cors',
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        signal: AbortSignal.timeout(10000)
                    });
                    console.log("Comment analysis request has been sent.");
                }

                let successMessage = "Analysis request completed successfully. GPT is processing the analysis, and you will receive the results via email within 5 minutes.";
                if (analyzeComments) successMessage += " Detailed comment analysis is also being performed.";
                successMessage += " Please wait a moment ^^";
                displayResult(successMessage, "success");

            } catch (error) {
                displayResult("An error occurred: " + error.message, "error");
            } finally {
                document.getElementById("submit-button").disabled = false;
                document.getElementById("loading-spinner").style.display = "none";
                isSubmitting = false;
            }
        });
    </script>
</body>
</html>
